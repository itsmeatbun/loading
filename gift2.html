<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Multi Trigger Overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="transparent" />
  <style>
    :root{
      --spawn-duration-ms: 3600;  /* default durasi */
      --max-on-screen: 24;        /* batas elemen total */
    }
    html,body{
      width:100%;height:100%;
      margin:0;padding:0;
      background:transparent;
      overflow:hidden;
    }
    .stage{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      aspect-ratio:9/16;
      background:transparent;
      overflow:hidden; pointer-events:none;
      z-index: 9999;
    }
    .spark{
      position:absolute;
      will-change: transform, opacity;
      transform: translate(-50%,-50%) scale(0.9) rotate(var(--rot,0deg));
      opacity:0;
      pointer-events:none;
      image-rendering:auto;
      filter: drop-shadow(0 6px 20px rgba(0,0,0,.25));
      animation:
        popfade var(--life, var(--spawn-duration-ms)) ease-in-out forwards,
        drift var(--life, var(--spawn-duration-ms)) linear forwards;
    }
    /* masuk ‚Üí stay ‚Üí keluar */
    @keyframes popfade{
      0%   {opacity:0; transform: translate(-50%,-50%) scale(.6) rotate(var(--rot,0deg));}
      12%  {opacity:1; transform: translate(-50%,-50%) scale(1) rotate(calc(var(--rot,0deg) + 3deg));}
      80%  {opacity:1; transform: translate(-50%,-50%) scale(1) rotate(calc(var(--rot,0deg) - 3deg));}
      100% {opacity:0; transform: translate(-50%,-50%) scale(.6) rotate(var(--rot,0deg));}
    }
    /* sedikit gerak supaya ‚Äúhidup‚Äù */
    @keyframes drift{
      0%   { transform: translate(calc(-50% + 0px), calc(-50% + 0px)) scale(1) rotate(var(--rot,0deg)); }
      100% { transform: translate(calc(-50% + var(--dx,0px)), calc(-50% + var(--dy,0px))) scale(1) rotate(var(--rot,0deg)); }
    }

    .status{
      position:fixed; left:10px; top:10px;
      font:600 12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#fff; background:rgba(0,0,0,.35);
      padding:6px 10px; border-radius:10px;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      pointer-events:none; z-index:10000;
    }
    .status.ok{ background: rgba(4,120,87,.35); }
    .status.err{ background: rgba(185,28,28,.45); }
  </style>
</head>
<body>
  <div class="stage" id="stage"></div>
  <div class="status" id="status">‚è≥ connecting‚Ä¶</div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    /**********************
     * KONFIG
     **********************/
    const SOCKET_URL = "http://localhost:62025";

    /**
     * TRIGGER_MAP:
     * key: keyword (lowercase), value: konfigurasi
     * - sources: array URL/path GIF
     * - count: berapa GIF ditaruh tiap trigger
     * - size: [minPx, maxPx]
     * - lifeMs: override durasi tampil (opsional)
     * - marginPct: area aman dari tepi (opsional, default 8)
     */
    const TRIGGER_MAP = {
      "!light": {
        sources: [
          "light.gif",
          // Tambah variasi bebas:
          // "https://media.tenor.com/0Z3CAc1l6aAAAAAC/sparkle-stars.gif",
        ],
        count: 4,
        size: [120, 220],
        lifeMs: 3400,
        marginPct: 10,
      },
      "!star": {
        sources: [
          "star.gif",
        ],
        count: 6,
        size: [90, 160],
        lifeMs: 3200,
      },
      "!heart": {
        sources: [
          "heart.gif",
        ],
        count: 5,
        size: [110, 180],
        lifeMs: 3600,
      },
      "!boom": {
        sources: [
          "boom.gif",
        ],
        count: 3,
        size: [180, 260],
        lifeMs: 2800,
        marginPct: 12,
      },
      "üëèüèª": {
        sources: [
          "clap.gif",
        ],
        count: 3,
        size: [100, 160],
        lifeMs: 2800,
        marginPct: 12,
      },
      "üëèüèΩ": {
        sources: [
          "clap.gif",
        ],
        count: 3,
        size: [100, 160],
        lifeMs: 2800,
        marginPct: 12,
      },"üëè": {
        sources: [
          "clap.gif",
        ],
        count: 3,
        size: [100, 160],
        lifeMs: 2800,
        marginPct: 12,
      },
      "!clap": {
        sources: [
          "clap.gif",
        ],
        count: 5,
        size: [100, 160],
        lifeMs: 2800,
        marginPct: 12,
      },
    };

    const DEFAULT_SIZE = [120, 260];
    const DEFAULT_MARGIN = 8;

    /**********************
     * UTIL
     **********************/
    const stageEl = document.getElementById("stage");
    const statusEl = document.getElementById("status");

    const pickRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    const randFloat = (min, max) => Math.random() * (max - min) + min;

    function maxOnScreen(){
      const n = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--max-on-screen"));
      return isNaN(n) ? 24 : n;
    }

    function clampSpawn(){
      const nodes = stageEl.querySelectorAll(".spark");
      const limit = maxOnScreen();
      const overflow = nodes.length - limit;
      if (overflow >= 0) {
        // hapus paling awal dulu biar gantian
        for (let i=0; i<=overflow; i++) nodes[i]?.remove();
      }
    }

    function spawnOne({ src, sizeRange, marginPct, lifeMs }){
      clampSpawn();

      const img = document.createElement("img");
      img.className = "spark";
      img.src = src;

      // ukuran random
      const [minPx, maxPx] = sizeRange || DEFAULT_SIZE;
      const w = randInt(minPx, maxPx);
      img.style.width = w + "px";
      img.style.height = "auto";

      // posisi random
      const safe = (typeof marginPct === "number" ? marginPct : DEFAULT_MARGIN);
      const xPct = randFloat(safe, 100 - safe);
      const yPct = randFloat(safe, 100 - safe);
      img.style.left = xPct + "%";
      img.style.top  = yPct + "%";

      // animasi param
      const life = lifeMs || parseInt(getComputedStyle(document.documentElement).getPropertyValue("--spawn-duration-ms")) || 3600;
      img.style.setProperty("--life", life + "ms");
      img.style.setProperty("--rot", randInt(-12, 12) + "deg");
      img.style.setProperty("--dx", randInt(-30, 30) + "px");
      img.style.setProperty("--dy", randInt(-40, 40) + "px");

      // cleanup
      setTimeout(() => img.remove(), life + 60);

      // debug load error
      img.addEventListener("error", () => console.warn("‚ö†Ô∏è GIF gagal dimuat:", src));

      stageEl.appendChild(img);
    }

    function spawnByTrigger(triggerKey){
      const cfg = TRIGGER_MAP[triggerKey];
      if (!cfg || !Array.isArray(cfg.sources) || cfg.sources.length === 0) return;
      const n = Math.max(1, cfg.count || 1);
      for (let i=0; i<n; i++){
        const src = pickRandom(cfg.sources);
        spawnOne({
          src,
          sizeRange: cfg.size || DEFAULT_SIZE,
          marginPct: cfg.marginPct,
          lifeMs: cfg.lifeMs,
        });
      }
    }

    function extractTriggers(textRaw){
      if (!textRaw) return [];
      const text = String(textRaw).toLowerCase();
      const found = [];
      for (const key of Object.keys(TRIGGER_MAP)){
        if (text.includes(key)) found.push(key);
      }
      return found;
    }

    /**********************
     * SOCKET + HANDLER
     **********************/
    const socket = io(SOCKET_URL, { transports:["websocket"] });

    socket.on("connect", () => {
      statusEl.textContent = `‚úÖ connected (${socket.id})`;
      statusEl.classList.remove("err"); statusEl.classList.add("ok");
    });
    socket.on("disconnect", (r) => {
      statusEl.textContent = `‚ö†Ô∏è disconnected: ${r}`;
      statusEl.classList.remove("ok"); statusEl.classList.add("err");
    });
    socket.on("connect_error", (e) => {
      statusEl.textContent = `‚ùå connect error: ${e?.message || e}`;
      statusEl.classList.remove("ok"); statusEl.classList.add("err");
    });

    // server kirim payload universal {event, data}
    socket.on("message", (payload) => {
      if (!payload || typeof payload !== "object") return;
      const { event, data } = payload;
      if (event === "chat" && data) onIncomingChat(data);
    });

    // server emit langsung 'chat', {uniqueId, comment}
    socket.on("chat", (chat) => onIncomingChat(chat));

    function onIncomingChat(obj){
      const comment = obj?.comment ?? obj?.text ?? "";
      const keys = extractTriggers(comment);
      if (keys.length){
        // eksekusi semua trigger yang ditemukan
        keys.forEach(spawnByTrigger);
      }
    }

    /**********************
     * TEST MANUAL:
     * T = "!light", Y = "!star", U = "!heart", I = "!boom"
     **********************/
    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if (k === "t") onIncomingChat({comment:"!light"});
      if (k === "y") onIncomingChat({comment:"!star"});
      if (k === "u") onIncomingChat({comment:"!heart"});
      if (k === "i") onIncomingChat({comment:"!boom"});
      if (k === "p") onIncomingChat({comment:"wow !light !heart !star combo"}); // multi
    });
  </script>
</body>
</html>
