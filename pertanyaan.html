<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Chat Command → Question Cards (Queued)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="transparent" />
  <style>
    :root{
      /* Tuning utama */
      --card-life-ms: 11000;       /* total durasi kartu di layar */
      --enter-ms: 900;             /* animasi masuk */
      --exit-ms: 700;              /* animasi keluar */
      --next-delay-ms: 700;        /* jeda sebelum kartu berikutnya */
      --max-on-screen: 1;          /* hanya 1 kartu di layar */
      --queue-size: 80;            /* maksimal panjang antrian */
      --stack-gap: 12px;
      --safe-margin-x: 6vw;
      --safe-margin-bottom: 3vh;
    }

    html,body{
      width:100%; height:100%;
      margin:0; padding:0;
      background:transparent;
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .stage{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      aspect-ratio: 9/16;
      background:transparent;
      pointer-events:none;
      z-index: 9999;
    }
    .stack{
      position:absolute;
      left:50%;
      bottom: var(--safe-margin-bottom);
      transform: translateX(-50%);
      width: clamp(260px, 72vw, 560px);
      max-width: calc(100vw - (var(--safe-margin-x)*2));
      display:flex;
      flex-direction:column-reverse;
      align-items:center;
      gap: var(--stack-gap);
      padding: 0 var(--safe-margin-x);
    }

    .qcard{
      position:relative;
      width:100%;
      pointer-events:none;
      color:#fff;
      background: radial-gradient(120% 140% at 10% 10%, rgba(255,255,255,.12), rgba(255,255,255,.06)),
                  linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 8px 28px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border-radius: 18px;
      overflow:hidden;

      opacity:0;
      transform: translateY(30%) scale(.96);
      animation:
        enterUp var(--enter-ms) cubic-bezier(.2,.9,.25,1.0) forwards,
        floaty calc(var(--card-life-ms) - var(--enter-ms) - var(--exit-ms)) ease-in-out var(--enter-ms) forwards,
        exitDown var(--exit-ms) cubic-bezier(.5,0,.9,.2) calc(var(--card-life-ms) - var(--exit-ms)) forwards;
    }
    .qcard .bar{
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(255,255,255,.20), rgba(255,255,255,0) 50%),
        radial-gradient(60% 140% at 10% 0%, rgba(99,102,241,.35), rgba(236,72,153,.28) 48%, rgba(14,165,233,.22) 90%);
      opacity:.55;
      pointer-events:none;
    }
    .qcard .inner{ position:relative; padding: 16px 18px 14px 18px; }
    .qcard .meta{
      display:flex; align-items:center; gap:10px;
      font-weight:700; font-size:13px; letter-spacing:.2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
      opacity:.95;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(6px);
    }
    .uname{ font-weight:800; }

    .qtext{
      margin-top:10px;
      font-weight:800;
      line-height:1.2;
      font-size: clamp(18px, 3.6vw, 28px);
      text-shadow: 0 3px 18px rgba(0,0,0,.45);
    }
    .hint{ margin-top:8px; font-size:12px; opacity:.9; font-weight:600; letter-spacing:.25px; }

    .progress{
      position:absolute; left:0; right:0; bottom:0;
      height:4px; overflow:hidden; background: rgba(255,255,255,.12);
    }
    .progress > i{
      display:block; height:100%;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6, #22d3ee);
      background-size: 200% 100%;
      animation: prog var(--card-life-ms) linear forwards, hue 8s linear infinite;
      filter: saturate(120%);
    }

    .status{
      position:fixed; left:10px; top:10px;
      font:600 12px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#fff; background:rgba(0,0,0,.35);
      padding:6px 10px; border-radius:10px;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      pointer-events:none; z-index:10000;
    }
    .status.ok{ background: rgba(4,120,87,.35); }
    .status.err{ background: rgba(185,28,28,.45); }

    @keyframes enterUp{
      0%{ opacity:0; transform: translateY(30%) scale(.96) }
      60%{ opacity:1; transform: translateY(-6%) scale(1.01) }
      100%{ opacity:1; transform: translateY(0%) scale(1) }
    }
    @keyframes floaty{
      0%{ transform: translateY(0%) }
      50%{ transform: translateY(-3%) }
      100%{ transform: translateY(0%) }
    }
    @keyframes exitDown{
      0%{ opacity:1; transform: translateY(0%) scale(1) }
      100%{ opacity:0; transform: translateY(15%) scale(.98) }
    }
    @keyframes prog{ 0%{ width: 100% } 100%{ width: 0% } }
    @keyframes hue{ 0%{ filter: hue-rotate(0deg) } 100%{ filter: hue-rotate(360deg) } }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="stack" id="stack"></div>
  </div>
  <div class="status" id="status">⏳ connecting…</div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    /********** KONFIG **********/
    const SOCKET_URL = "http://localhost:62025";

    /* Perintah yang memicu kartu */
    const COMMANDS = ["!pertanyaan", "!q", "!question"];

    /* Bank pertanyaan: bebas edit */
    const QUESTIONS = ["If you were a food, what flavor would you be and why?",
  "What's your comfort movie or anime lately?",
  "Team cat, dog, or a cute green lizard? Defend your choice!",
  "What's your guilty pleasure snack?",
  "If you could teleport once today, where would you go?",
  "Name one random skill you wish you had!",
  "What's one song that always boosts your mood?",
  "Morning person: coffee, tea, or just water?",
  "What's the most useless item you still keep?",
  "What little thing made you smile today?",
  "If you could live in an anime world, which one?",
  "What's one food you could eat every single day?",
  "If you were a pet, which animal would you be?",
  "Have you ever laughed so hard you cried? Tell us!",
  "Would you rather read minds or be invisible?",
  "If you had a free week off, where would you spend it?",
  "What's one small habit that comforts you?",
  "If you were a superhero, what would your first power be?",
  "What's the weirdest drink you've ever tried?",
  "Name 3 things that make you happy right now.",
  "If you were a video game character, what class would you pick?",
  "What's your funniest embarrassing moment?",
  "Do you prefer sunrise or sunset?",
  "If you had a personal robot, what would you make it do first?",
  "What's one must-have item when traveling?",
  "If you became a celebrity, what would you be known for?",
  "What's the most overrated food in your opinion?",
  "Would you rather take a long nap or sleep early at night?",
  "What's a hobby you can do for hours without noticing time?",
  "If you could meet your 10-year-old self, what would you say?",
  "Which fictional character would you want as your best friend?",
  "What's your go-to emoji in chat?",
  "If you had an unlimited voucher, what would you shop for?",
  "Have you ever fallen asleep in a random place?",
  "What's a random skill you actually have?",
  "If you could be fluent in any language instantly, which one?",
  "Name a childhood food that makes you nostalgic.",
  "If you were an NPC, what line would you always repeat?",
  "Would you rather be a great singer or a great artist?",
  "What do you usually do when you're in a bad mood?",
  "Name 3 random things near you right now.",
  "What's the smallest gift that made you super happy?",
  "If you had to change your name, what would it be?",
  "Summer or rainy season?",
  "If you had one extra hour every day, what would you do?",
  "Ever experienced a weird déjà vu?",
  "If you owned a shop, what would you sell?",
  "What's the last show that got you hooked?",
  "If you could instantly play an instrument, which one?",
  "One word to describe your mood right now?",
  "If you were an alien, what would your planet look like?",
  "What's the app you open most often?",
  "Do you prefer walking at night or in the morning?",
  "What's your favorite dessert?",
  "If you had wings, what would they look like?",
  "What's the music genre that calms you most?",
  "Would you rather use an old tiny phone or a giant tablet?",
  "Name one small thing you're grateful for today.",
  "If you started a small business, what would it be?",
  "What's the food you crave the most?",
  "If you had a teleport door, where would you put it?",
  "What's an item you keep but never use?",
  "If you were in a horror movie, would you survive or die first?",
  "Would you rather eat super spicy or super salty?",
  "If you could swap lives with a celebrity for one day, who?",
  "What's a random quote you remember?",
  "Sweet or salty snacks?",
  "If you had a fantasy pet, what would it be?",
  "What's one quirky habit you have?",
  "If the world had no internet for a week, what would you do?",
  "What's one game you wish you could replay fresh?",
  "Weird ice cream flavor or classic vanilla?",
  "If you were a CEO, what field would it be?",
  "What's the item you touch most every day?",
  "Name a guilty pleasure drama or movie.",
  "If you could change your hair instantly, what color?",
  "City life or quiet countryside?",
  "What's the most relaxing sound for you?",
  "If you had one magic spell, what would you use it for?",
  "What's a random silly moment that made you laugh?",
  "Would you rather sleep on a fluffy bed or a cozy sofa?",
  "If you owned a ship, what would you name it?",
  "What's the most underrated food for you?",
  "If you could change the world's currency into anything, what?",
  "What's the most random thing in your bag?",
  "If you were a cartoon character, whose style would you take?",
  "What's a weird skill you'd like to try?",
  "Would you rather fly low or run super fast?",
  "If you could give everyone here one gift, what would it be?",
  "What's a small object that makes you feel safe?",
  "If you were in an RPG, what weapon would you choose?",
  "What's the funniest habit your friend has?",
  "Would you rather sleep early or stay up late?",
  "If you had a personal theme song, what would it be?",
  "What's one food you used to hate but now like?",
  "If you had 3 clones, what would you make them do?",
  "What's an emoji people always misuse?",
  "If you could name a star, what name would you pick?",
  "What's the strangest food you've tried?",
  "Time travel once: past or future?",
  "What's a tiny item that makes you smile?",
  "If you started a random cult, what theme would it have?",
  "What's your all-time favorite drink?",
  "If everyone could hear you for 5 seconds, what would you say?",
  "What's something silly you want to try without being judged?",
  "If you could bring a game skill into real life, what would it be?"
    ];

    const HINT_TEXT = "Jawab di chat ya 💬";
    const RECENT_NO_REPEAT = 5;

    /* Anti-spam ringan per user (cooldown detik) */
    const USER_COOLDOWN_MS = 5000;

    /********** STATE **********/
    const stackEl = document.getElementById("stack");
    const statusEl = document.getElementById("status");
    const queue = [];
    let activeCards = 0;
    let recentQ = [];
    const lastUse = new Map(); // username -> timestamp

    function cssNum(varName, fallback){
      const v = parseInt(getComputedStyle(document.documentElement).getPropertyValue(varName));
      return isNaN(v) ? fallback : v;
    }
    const CARD_LIFE_MS = () => cssNum("--card-life-ms", 11000);
    const ENTER_MS     = () => cssNum("--enter-ms", 900);
    const EXIT_MS      = () => cssNum("--exit-ms", 700);
    const NEXT_DELAY   = () => cssNum("--next-delay-ms", 700);
    const MAX_ONSCREEN = () => cssNum("--max-on-screen", 1);
    const MAX_QUEUE    = () => cssNum("--queue-size", 80);

    function pickQuestion(){
      const pool = QUESTIONS.filter(q => !recentQ.includes(q));
      const q = pool.length ? pool[Math.floor(Math.random()*pool.length)] : QUESTIONS[Math.floor(Math.random()*QUESTIONS.length)];
      recentQ.push(q);
      if (recentQ.length > RECENT_NO_REPEAT) recentQ.shift();
      return q;
    }
    function sanitize(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function pushQueue(item){
      if (queue.length >= MAX_QUEUE()) queue.shift();
      queue.push(item);
      pump();
    }

    /* Satu-per-satu */
    function pump(){
      if (activeCards >= MAX_ONSCREEN()) return;
      const data = queue.shift();
      if (!data) return;
      spawnCard(data);
    }

    function createCardElement({username, question}){
      const card = document.createElement("div");
      card.className = "qcard";
      card.style.setProperty("--card-life-ms", `${CARD_LIFE_MS()}ms`);
      card.style.setProperty("--enter-ms", `${ENTER_MS()}ms`);
      card.style.setProperty("--exit-ms", `${EXIT_MS()}ms`);

      card.innerHTML = `
        <div class="bar"></div>
        <div class="inner">
          <div class="meta">
            <span class="badge">💬 Command</span>
            <span class="badge"><span class="uname">${sanitize(username || "Viewer")}</span> minta pertanyaan</span>
          </div>
          <div class="qtext">${sanitize(question)}</div>
          <div class="hint">${sanitize(HINT_TEXT)}</div>
        </div>
        <div class="progress"><i></i></div>
      `;
      return card;
    }

    function spawnCard(info){
      activeCards = 1;
      const card = createCardElement(info);
      stackEl.appendChild(card);

      const total = CARD_LIFE_MS();
      setTimeout(() => {
        card.remove();
        activeCards = 0;
        setTimeout(pump, NEXT_DELAY());
      }, total + 40);
    }

    /********** CHAT PARSER **********/
    function extractText(payload){
      // Coba beberapa kemungkinan field
      return payload?.comment ?? payload?.text ?? payload?.message ?? payload?.body ?? "";
    }
    function extractUser(payload){
      return payload?.username ?? payload?.user ?? payload?.sender ?? payload?.name ?? payload?.author ?? "Viewer";
    }
    function hasCommand(textRaw){
      const t = String(textRaw || "").toLowerCase();
      return COMMANDS.some(cmd => t.includes(cmd));
    }

    /* Cooldown per user biar nggak diserbu satu orang */
    function allowUser(username){
      const now = Date.now();
      const last = lastUse.get(username) || 0;
      if (now - last < USER_COOLDOWN_MS) return false;
      lastUse.set(username, now);
      return true;
    }

    /********** SOCKET **********/
    const socket = io(SOCKET_URL, { transports:["websocket"] });

    socket.on("connect", () => {
      statusEl.textContent = `✅ connected (${socket.id})`;
      statusEl.classList.remove("err"); statusEl.classList.add("ok");
    });
    socket.on("disconnect", (r) => {
      statusEl.textContent = `⚠️ disconnected: ${r}`;
      statusEl.classList.remove("ok"); statusEl.classList.add("err");
    });
    socket.on("connect_error", (e) => {
      statusEl.textContent = `❌ connect error: ${e?.message || e}`;
      statusEl.classList.remove("ok"); statusEl.classList.add("err");
    });

    /* Pola 1: universal {event, data} */
    socket.on("message", (payload) => {
      if (!payload || typeof payload !== "object") return;
      const { event, data } = payload;
      if (String(event || "").toLowerCase() !== "chat") return;
      onIncomingChat(data);
    });

    /* Pola 2: emit langsung 'chat', payload bisa {username, comment} */
    socket.on("chat", (chat) => onIncomingChat(chat));

    function onIncomingChat(obj){
      const text = extractText(obj);
      if (!hasCommand(text)) return;

      const username = extractUser(obj);
      if (!allowUser(username)) return;

      pushQueue({
        username,
        question: pickQuestion(),
      });
    }

    /********** TEST MANUAL **********/
    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if (k === "p"){ // P = test command
        onIncomingChat({ username:"Tester", comment:"!pertanyaan dong" });
      }
    });
  </script>
</body>
</html>
